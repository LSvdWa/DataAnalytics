import pandas as pdimport plotly.graph_objects as goimport plotly.express as pxfrom plotly.subplots import make_subplotsfrom dash import Dash, html, dcc, Input, Outputimport numpy as np# read the csv and make it a pandas.DataFrameframe = pd.DataFrame(pd.read_csv("./airlinedelaycauses_DelayedFlights.zip"))frame.describe(include='all')# 30 columns, 11 rows# 5 object columns: UniqueCarrier, TailNum, Origin, Dest, CancellationCode# 25 numeric columns# objects = ['UniqueCarrier', 'TailNum', 'Origin', 'Dest', 'CancellationCode']# numerics = ['Unnamed: 0', 'Year', 'Month', 'DayOfMonth', 'DayOfWeek', 'DepTime', 'CRSDepTime', 'ArrTime',#       'CRSArrTime', 'FlightNum', 'ActualElapsedTime', 'CRSElapsedTime', 'AirTime', 'ArrDelay', 'DepDelay', 'Distance',#       'TaxiIn', 'TaxiOut', 'Cancelled', 'Diverted', 'CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay',#       'LateAircraftDelay']us_cities = pd.read_csv("./airports.csv")iataCodes = list(us_cities['iata_code'].dropna().unique())dictio = {}for i, j in enumerate(us_cities['iata_code']):    if len(iataCodes) < 1:        break    if j in iataCodes:        dictio[j] = (us_cities['latitude_deg'][i], us_cities['longitude_deg'][i], j)        iataCodes.remove(j)framew = (pd.DataFrame(dictio))framew.rename(index={0: 'latitude', 1: 'longitude', 2: 'airport'}, inplace=True)nframe = framew.transpose()# === SAMPLE DATA ===# flights without duplicates, to make drawing fasterflights = frame.copy()df_merged = (pd.merge(flights, nframe, left_on='Origin', right_on='airport', how='left')             .rename(columns={'latitude': 'Origin_Latitude', 'longitude': 'Origin_Longitude'})             .drop(columns='airport'))df_mergedDest = (pd.merge(df_merged, nframe, left_on='Dest', right_on='airport', how='left')                 .rename(columns={'latitude': 'Dest_Latitude', 'longitude': 'Dest_Longitude'})                 .drop(columns='airport'))df = (df_mergedDest[['Origin', 'Dest', 'Origin_Latitude', 'Origin_Longitude', 'Dest_Latitude', 'Dest_Longitude']]      .drop_duplicates())counts = df_mergedDest[['Origin','Dest_Latitude', 'Dest_Longitude']].value_counts().reset_index(name='count')print(len(counts['count']))fig_heat = px.density_map(    counts[['Dest_Latitude', "Dest_Longitude", "count"]],    lat="Dest_Latitude",    lon="Dest_Longitude",    z="count",    zoom=2,    title="World Heatmap",    radius=15,    opacity=0.8,    color_continuous_scale="Viridis",    map_style="open-street-map")# === DASH APP ===app = Dash(__name__)app.layout = html.Div([    html.H1("Interactive Global Flight Map", style={'textAlign': 'center'}),    html.Div([        html.Label("Search Origin Airport:"),        dcc.Dropdown(            id='origin-filter',            options=[{'label': i, 'value': i} for i in sorted(df['Origin'].unique())],            placeholder="Select Origin...",            style={'width': '45%', 'display': 'inline-block', 'marginRight': '2%'}        ),    ], style={'textAlign': 'center', 'marginBottom': '20px'}),    html.Div([        html.Label("Search Destination Airport:"),        dcc.Dropdown(            id='dest-filter',            options=[{'label': i, 'value': i} for i in sorted(df['Dest'].unique())],            placeholder="Select Destination...",            style={'width': '45%', 'display': 'inline-block'}        ),    ], style={'textAlign': 'center', 'marginBottom': '20px'}),    dcc.Graph(id='flight-map', style={'height': '85vh'}),    dcc.Graph(id='delay-pieChart', style={'height': '85vh'}),    dcc.Graph(id='delay-pieChart2', style={'height': '85vh'}),    html.Hr(),    html.H2("World Heatmap (destination count)"),    dcc.Graph(id="world-heatmap", figure=fig_heat, style={'height': '85vh'})])@app.callback(    Output('flight-map', 'figure'),    [Input('origin-filter', 'value'),     Input('dest-filter', 'value')])def update_map(selected_origin, selected_dest):    dff = df.copy()    if selected_origin:        dff = dff[dff['Origin'] == selected_origin]    if selected_dest:        dff = dff[dff['Dest'] == selected_dest]    fig = go.Figure()    for _, row in dff.iterrows():        fig.add_trace(go.Scattergeo(            lon=[row['Origin_Longitude'], row['Dest_Longitude']],            lat=[row['Origin_Latitude'], row['Dest_Latitude']],            mode='lines',            line=dict(width=2, color='blue'),            opacity=0.4,            hoverinfo='text',            text=f"{row['Origin']} â†’ {row['Dest']}"        ))    all_airports = pd.concat([        df[['Origin', 'Origin_Latitude', 'Origin_Longitude']].rename(columns={            'Origin': 'Code', 'Origin_Latitude': 'Latitude', 'Origin_Longitude': 'Longitude'        }),        df[['Dest', 'Dest_Latitude', 'Dest_Longitude']].rename(columns={            'Dest': 'Code', 'Dest_Latitude': 'Latitude', 'Dest_Longitude': 'Longitude'        })    ]).drop_duplicates(subset='Code')    fig.add_trace(go.Scattergeo(        lon=all_airports['Longitude'],        lat=all_airports['Latitude'],        mode='markers',        marker=dict(size=5, color='red', opacity=0.7),        text=all_airports['Code'],        hoverinfo='text',        name='Airports'    ))    fig.update_layout(        title=f"Flight Routes ({len(dff)} routes)",        showlegend=False,        geo=dict(            projection_type='natural earth',            showland=True,            landcolor='rgb(243,243,243)',            countrycolor='rgb(204,204,204)'        ),        margin=dict(l=0, r=0, t=50, b=0)    )    return fig@app.callback(    Output('delay-pieChart', 'figure'),    [Input('origin-filter', 'value'),     Input('dest-filter', 'value')])def update_pie_chart(selected_origin, selected_dest):    fig = make_subplots(rows=1, cols=3,                        subplot_titles=("Flight Delays (amount of time)", "Flight Delays (times delayed)", "Flight Carriers"),                        specs=[[{"type": "pie"}, {"type": "pie"}, {"type": "pie"}]])    if selected_origin:        df_delay = frame[(frame['Origin'] == selected_origin)]    elif selected_dest:        df_delay = frame[(frame['Dest'] == selected_dest)]    elif selected_origin and selected_dest:        df_delay = frame[(frame['Origin'] == selected_origin) & (frame['Dest'] == selected_dest)]    else:        df_delay = frame    delay_columns = ['CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay', 'LateAircraftDelay']    delay_sums = df_delay[delay_columns].sum()    delay_df = delay_sums.reset_index()    delay_df.columns = ['DelayType', 'TotalDelay']    pie_chart_1 = go.Pie(labels=delay_df['DelayType'], values=delay_df['TotalDelay'], name='Total Delay')    fig.add_trace(pie_chart_1, row=1, col=1)    delay_count = df_delay[delay_columns].apply(lambda x: (x != 0) & pd.notna(x)).sum()    delay_df_count = delay_count.reset_index()    delay_df_count.columns = ['DelayType', 'TotalDelay']    pie_chart_2 = go.Pie(labels=delay_df_count['DelayType'], values=delay_df_count['TotalDelay'], name='Delay Count')    fig.add_trace(pie_chart_2, row=1, col=2)    fig.update_layout(title_text="Flight Delays Overview",                      showlegend=True,                      height=600,                      title_x=0.5)    countsdf = df_delay['UniqueCarrier'].value_counts()    pie_chart_3 = go.Pie(labels=countsdf.index,    values=countsdf.values,    textinfo='label+percent',    hoverinfo='label+value',    name='Carrier type')    fig.add_trace(pie_chart_3, row=1, col=3)    fig.update_layout(title_text="Flight Carrier Overview",                      showlegend=True,                      height=600,                      title_x=0.5)    return fig@app.callback(    Output('delay-pieChart2', 'figure'),    [Input('origin-filter', 'value'),     Input('dest-filter', 'value')])def update_pie_chart(selected_origin, selected_dest):    fig = make_subplots(rows=1, cols=3,                        subplot_titles=("Useless", "Flight status overview", "Copy"),                        specs=[[{"type": "pie"}, {"type": "pie"}, {"type": "pie"}]])    if selected_origin:        df_delay = frame[(frame['Origin'] == selected_origin)]    elif selected_dest:        df_delay = frame[(frame['Dest'] == selected_dest)]    elif selected_origin and selected_dest:        df_delay = frame[(frame['Origin'] == selected_origin) & (frame['Dest'] == selected_dest)]    else:        df_delay = frame    delay_columns = ['CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay', 'LateAircraftDelay']    delay_sums = df_delay[delay_columns].sum()    delay_df = delay_sums.reset_index()    delay_df.columns = ['DelayType', 'TotalDelay']    pie_chart_1 = go.Pie(labels=delay_df['DelayType'], values=delay_df['TotalDelay'], name='Useless')    fig.add_trace(pie_chart_1, row=1, col=1)    df_delay['status'] = np.select(        [df_delay['Diverted'] == 1,df_delay['Cancelled'] == 1, df_delay['CarrierDelay'] > 0, df_delay['WeatherDelay'] > 0, df_delay['NASDelay'] > 0, df_delay['SecurityDelay'] > 0, df_delay['LateAircraftDelay'] > 0],        ['Diverted','Cancelled', 'CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay', 'LateAircraftDelay'],        default='No delay/cancel/divert')    countts = df_delay['status'].value_counts()    pie_chart_2 = go.Pie(go.Pie(        labels=countts.index,        values=countts.values,        textinfo='label+percent',        name='Flight Status',        pull = [0.1, 0.05, 0.1,0.1,0.1,0.1,0.1,0.5,0.1]    ))    fig.add_trace(pie_chart_2, row=1, col=2)    fig.update_layout(title_text="Flight Status Overview",                      showlegend=True,                      height=600,                      title_x=0.5)    countsdf = df_delay['UniqueCarrier'].value_counts()    pie_chart_3 = go.Pie(labels=countsdf.index,    values=countsdf.values,    textinfo='label+percent',    hoverinfo='label+value',    name='Carrier type')    fig.add_trace(pie_chart_3, row=1, col=3)    fig.update_layout(title_text="Flight Status",                      showlegend=True,                      height=600,                      title_x=0.5)    return fig@app.callback(    Output('world-heatmap', 'figure'),    [Input('origin-filter', 'value'),     Input('dest-filter', 'value')])def update_heatmap(selected_origin, selected_dest):    filtered = counts[        counts['Origin'].apply(lambda x: selected_origin in x if selected_origin else True)].copy()    title = selected_origin    if title == None:        title = "any destination"    fig = px.density_map(        filtered[['Dest_Latitude', "Dest_Longitude", "count"]],        lat="Dest_Latitude",        lon="Dest_Longitude",        z='count',        radius=12,        map_style="open-street-map",        zoom=3,        center=dict(lat=30, lon=-90),        title=f"Heatmap arrivals from {title}"    )    return figapp.run(debug=True, use_reloader=False, port=2028)